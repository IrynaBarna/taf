<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Test Automation Framework: Running LXC Environment with ONS Builds</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Test Automation Framework
   &#160;<span id="projectnumber">01/31/17/16:21:23</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('run_lxc_page.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Running LXC Environment with ONS Builds </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#run_lxc_sec1">Preparation</a></li>
<li class="level1"><a href="#run_lxc_sec2">Install LXC (Linux Container)</a></li>
<li class="level1"><a href="#run_lxc_sec3">Tunnel interfaces</a></li>
<li class="level1"><a href="#run_lxc_sec4">Bridge Interfaces</a></li>
<li class="level1"><a href="#run_lxc_sec5">Install Quagga</a></li>
<li class="level1"><a href="#run_lxc_sec6">Starting SimSwitch Inside LXC</a></li>
<li class="level1"><a href="#run_lxc_sec7">Useful LXC Commands</a></li>
<li class="level1"><a href="#run_lxc_sec8">Running SimSwitch</a></li>
<li class="level1"><a href="#run_lxc_sec9">XML-RPC Notice</a></li>
<li class="level1"><a href="#run_lxc_sec10">Uninstalling Quagga</a></li>
<li class="level1"><a href="#run_lxc_sec11">Preparing the Linux Environment to Run CLI Test Cases on LXC SimSwitch</a></li>
<li class="level1"><a href="#run_lxc_sec12">All-In-One Edition</a></li>
</ul>
</div>
<div class="textblock"><p>This section describes how to run the LXC environment with ONS builds. </p>
<h1><a class="anchor" id="run_lxc_sec1"></a>
Preparation</h1>
<p>Get the latest distribution of SimSwitch and Quagga. Look for release files at: </p>
<pre class="fragment">     $ cp &lt;ONS_product_installation_path&gt;/prebuild-binaries/&lt;quagga_tar_file&gt; ~
     $ cp &lt;ONS_product_installation_path&gt;/prebuild-binaries/&lt;swtichpp_tar_file&gt; ~</pre><p> File name examples for switchpp and quagga: </p>
<pre class="fragment">     quagga-bin-x86_64-Ubuntu-12.04-0.99.22.tar.bz2
     switchpp-bin-x86_64-Ubuntu-12.04-&lt;version&gt;.tar.bz2</pre> <h1><a class="anchor" id="run_lxc_sec2"></a>
Install LXC (Linux Container)</h1>
<p>Install LXC: </p>
<pre class="fragment">     $ sudo apt-get install lxc</pre><p> Prepare the cgroup for the linux container: </p>
<pre class="fragment">     $ sudo mkdir /cgroup
     $ sudo mount none -t cgroup /cgroup</pre> <dl class="section note"><dt>Note</dt><dd>If you see an error after last command, just ignore it and continue.</dd></dl>
<p>To store the mount permanently, add the following line to /etc/fstab: </p>
<pre class="fragment">     $ sudo vim /etc/fstab
     none /cgroup cgroup defaults 0 0</pre> <h1><a class="anchor" id="run_lxc_sec3"></a>
Tunnel interfaces</h1>
<p>Check if you have uml-utilities installed: </p>
<pre class="fragment">     $ dpkg -l | grep uml-utilities</pre><p> If the command response is empty, install uml-utilities, which are necessary for creating the tun and tap interfaces used for the virtual host-only network. </p>
<pre class="fragment">     $ sudo apt-get install uml-utilities</pre><p> Just for testing that everything is ok, create and delete one tap interface:<br/>
 Create: </p>
<pre class="fragment">     $ sudo tunctl -b -u &lt;your local admin user or root&gt; -t tap0</pre><p> Delete: </p>
<pre class="fragment">     $ sudo tunctl -d tap0</pre><p> To create a persistent interface, add the following to /etc/network/interfaces: </p>
<pre class="fragment">     auto tap0
     iface tap0 inet manual
        pre-up /usr/sbin/tunctl -b -u root -t tap0
        post-down /usr/sbin/tunctl -d tap0</pre><h1><a class="anchor" id="run_lxc_sec4"></a>
Bridge Interfaces</h1>
<p>Check if you have bridge-utils installed. </p>
<pre class="fragment">    $ dpkg -l | grep bridge-utils</pre><p> If the command response is empty, install bridge-utils. </p>
<pre class="fragment">    $ sudo apt-get install bridge-utils</pre><p> Check your network environment with the ifconfig command; however, if you already have br0 interface with inet addr:10.0.5.100, skip this step.</p>
<dl class="section note"><dt>Note</dt><dd>The tap0 interface must be created and up.</dd></dl>
<p>This step is just for testing that everything is ok. In a terminal with sudo permissions: </p>
<pre class="fragment">    $ sudo brctl addbr br0
    $ sudo brctl addif br0 tap0
    $ brctl show
    $ sudo ifconfig br0 up
    $ sudo ifconfig br0 10.0.5.100/24
    $ ifconfig br0</pre><p> Now, br0 should be up and has ip addr: 10.0.5.100, mask: 255.255.255.0 Check network availability with ping.<br/>
<br/>
 Here, network '10.0.5.0' will be used for the lxc and vlab environment. IP '10.0.5.100' in network '10.0.5.0' will be used by vlab.<br/>
<br/>
 To store network changes permanently, add to /etc/network/interfaces: </p>
<pre class="fragment">    auto br0
    iface br0 inet static
        address 10.0.5.100
        netmask 255.255.255.0
        bridge_ports tap0
        bridge_stp off
        bridge_fd 0
        bridge_maxwait 0</pre><p> <b> !!! Check your network settings !!! </b> </p>
<pre class="fragment">    $ sudo /etc/init.d/networking restart</pre><p> The result of network restart should be [OK].<br/>
<br/>
 If not, check '/etc/network/interfaces' where you made changes.</p>
<h1><a class="anchor" id="run_lxc_sec5"></a>
Install Quagga</h1>
<ul>
<li>Create the directory /opt/simswitch OR clear it if it already exist and contains an older build. <pre class="fragment">    $ sudo mkdir /opt/simswitch</pre></li>
<li>Extract the Quagga distribution. <pre class="fragment">    $ sudo tar xjf ~/quagga-bin-x86_64-Ubuntu-12.04-0.99.22.tar.bz2 -C /opt/simswitch/</pre> </li>
</ul>
<h1><a class="anchor" id="run_lxc_sec6"></a>
Starting SimSwitch Inside LXC</h1>
<ul>
<li>Extract the simswitch tar file to /opt/simswitch (create one if needed). <pre class="fragment">    $ sudo tar xjf ~/switchpp-bin-x86_64-Ubuntu-12.04-1.0.1.1316-2.tar.bz2 -C /opt/simswitch/</pre></li>
<li>Start the first linux container with simswitch inside using ons-lxc shell script. <pre class="fragment">    $ cd /opt/simswitch/bin/
    $ sudo ./ons-ctl start -n 1 -i br0 -a 10.0.5.101/24</pre></li>
<li>Parameters usage: <code>./ons-ctl start -n &lt;instance number&gt;=""&gt; -i br0 -a &lt;containter-ipaddr&gt;/&lt; mask&gt; -p &lt;number of="" simswitch="" ports&gt;=""&gt; </code></li>
</ul>
<dl class="section attention"><dt>Attention</dt><dd><b>After ons-ctl execution you are alredy placed inside lxc console !!!</b></dd></dl>
<p>LXC IP will be '10.0.5.101', switch instance is '1'.</p>
<ul>
<li>Also, ons-ctl script will start vlab if it is not started manually before.<br/>
 To run several instances of LXCs with switchpp, you should modify &lt;containter-ip-addr&gt; and &lt;instance&gt;:</li>
</ul>
<pre class="fragment">    $ sudo ./ons-lxc -n 2 -i br0 -a 10.0.5.102/24
    $ sudo ./ons-lxc -n 3 -i br0 -a 10.0.5.103/24</pre><ul>
<li>Manually start vlab:</li>
</ul>
<pre class="fragment">    $ cd /opt/simswitch/
    $ sudo env LD_LIBRARY_PATH=$PWD/lib bin/vlab</pre><h1><a class="anchor" id="run_lxc_sec7"></a>
Useful LXC Commands</h1>
<p>Show running containers: </p>
<pre class="fragment">    $ sudo lxc-ls</pre><p> Stop container: </p>
<pre class="fragment">    $ sudo lxc-stop --name &lt;container name&gt;</pre><p> Also, if in lxc console and you type 'exit', the lxc container will be stopped: </p>
<pre class="fragment">    $ root@1:/opt/simswitch# exit</pre><h1><a class="anchor" id="run_lxc_sec8"></a>
Running SimSwitch</h1>
<p>After system reboot, to start simswitch into the LXC environment, you only need to run the ons-ctl shell script without any additional actions: </p>
<pre class="fragment">    $ sudo ./ons-lxc -n 1 -i br0 -a 10.0.5.101/24</pre> <h1><a class="anchor" id="run_lxc_sec9"></a>
XML-RPC Notice</h1>
<p>For XML-RPC connection in Python to VLAB and Switch, use IP addresses: </p>
<pre class="fragment">    vlab = xmlrpclib.ServerProxy("http://10.0.5.100:8050/RPC2")
    sw1 = xmlrpclib.ServerProxy("http://10.0.5.101:8081/RPC2")</pre> <h1><a class="anchor" id="run_lxc_sec10"></a>
Uninstalling Quagga</h1>
<p>If you have Quagga installed and you need to remove it, go where you installed quagga before (probably in '~/quagga') and simply run uninstall: </p>
<pre class="fragment">    $ cd ~/quagga/
    $ sudo make uninstall</pre><h1><a class="anchor" id="run_lxc_sec11"></a>
Preparing the Linux Environment to Run CLI Test Cases on LXC SimSwitch</h1>
<p>To be able run CLI test cases on LXC SimSwitch, you should add a special user on your system. Here is a list of commands that should be run: </p>
<pre class="fragment">    $ sudo useradd lxc_admin
    $ sudo passwd lxc_admin
    $ Enter new UNIX password: lxc_admin
    $ Retype new UNIX password: lxc_admin</pre><h1><a class="anchor" id="run_lxc_sec12"></a>
All-In-One Edition</h1>
<pre class="fragment">    $ sudo apt-get install lxc uml-utilities bridge-utils
    $ sudo vim /etc/fstab

    none /cgroup cgroup defaults 0 0

    $ sudo vim /etc/network/interfaces

    auto tap0
    iface tap0 inet manual
        pre-up /usr/sbin/tunctl -b -u root -t tap0
        post-down /usr/sbin/tunctl -d tap0
    auto br0
    iface br0 inet static
        address 10.0.5.100
        netmask 255.255.255.0
        bridge_ports tap0
        bridge_stp off
        bridge_fd 0
        bridge_maxwait 0

    $ sudo /etc/init.d/networking restart
    $ cp &lt;ONS_product_installation_path&gt;/prebuild-binaries/&lt;quagga_tar_file&gt; ~
    $ cp &lt;ONS_product_installation_path&gt;/prebuild-binaries/&lt;swtichpp_tar_file&gt; ~
    $ sudo mkdir /opt/simswitch
    $ sudo tar xjf ~/switchpp-bin-x86_64-Ubuntu-12.04-1.0.1.1316-2.tar.bz2 -C /opt/simswitch/
    $ sudo tar xjf ~/quagga-bin-x86_64-Ubuntu-12.04-0.99.22.tar.bz2 -C /opt/simswitch/
    $ sudo useradd lxc_admin
    $ sudo passwd lxc_admin</pre> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Jan 31 2017 16:21:23 for Test Automation Framework by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
